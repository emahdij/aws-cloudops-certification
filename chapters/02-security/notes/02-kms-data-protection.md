# KMS and Data Protection

## Overview

AWS Key Management Service (KMS) creates, manages, and controls encryption keys that protect your data across AWS services. KMS integrates with most AWS services to enable encryption at rest without writing code.

**Regional Service**: KMS keys exist only in the region where created. Data encrypted in us-east-1 cannot be decrypted by a key in us-west-2.

---

## Part 1: Key Types Supported by KMS

### Symmetric Keys (AES-256)

Most common. Single key for both encryption and decryption.

**Use for**:
- Encrypting data at rest (S3, EBS, RDS)
- Envelope encryption
- Most AWS service integrations

**Cannot**:
- Export the key material
- Use outside AWS

### Asymmetric Keys (RSA & ECC)

Public/private key pairs. Public key encrypts, private key decrypts.

**RSA Key Types**:
- RSA_2048
- RSA_3072  
- RSA_4096

**ECC Key Types** (Elliptic Curve):
- ECC_NIST_P256
- ECC_NIST_P384
- ECC_NIST_P521
- ECC_SECG_P256K1

**Use for**:
- Digital signatures
- Encryption outside AWS (download public key)
- SSL/TLS certificates

**Example**: Client encrypts data with public key, sends to AWS, Lambda decrypts with private key.

### HMAC Keys

Hash-based message authentication codes. Used for generating and verifying tokens.

**Use for**:
- API authentication tokens
- Message integrity verification
- Rate limiting tokens

### Data Keys

Not a key type in KMS, but important concept:
- Generated by KMS for encrypting large amounts of data
- Used in envelope encryption
- Returned in plaintext + encrypted form

> **Exam Alert**: Symmetric keys are most common. Asymmetric keys allow operations outside AWS. HMAC keys for token generation.

---

## Part 2: Customer Managed vs AWS Managed Keys

## Part 2: Customer Managed vs AWS Managed Keys

| Type | Cost | Control | Rotation | Use Case |
|------|------|---------|----------|----------|
| **Customer Managed** | $1/month + API calls | Full control | Automatic yearly | Custom policies, cross-account |
| **AWS Managed** | Free (API calls only) | No control | Every 3 years | Standard encryption |

**Customer Managed Keys**:
- You create and control
- Full policy control
- Can be deleted (7-30 day waiting period)
- Required for cross-account access

**AWS Managed Keys**:
- AWS creates automatically
- Cannot modify policy
- Cannot be deleted
- Prefix: `aws/service-name` (e.g., `aws/s3`, `aws/rds`)

### Key Rotation

**How Often Can You Rotate?**

| Key Type | Automatic Rotation | Manual Rotation | Cost |
|----------|-------------------|-----------------|------|
| Customer Managed | Every 365 days | Anytime (create new key) | **No extra cost** |
| AWS Managed | Every 1,095 days (3 years) | Cannot | **No extra cost** |
| Imported Key Material | Not available | Manual only | **No extra cost** |

**Important**: Rotation has **NO additional cost**. It's free for both automatic and manual rotation.

**What Happens During Rotation**:
- AWS keeps old key material
- New key material created
- Old encrypted data still decryptable (uses old key material automatically)
- New encryption uses new key material
- Transparent to applications

> **Exam Alert**: Key rotation is automatic for customer managed keys (yearly) and AWS managed keys (every 3 years). No cost for rotation. Old data remains decryptable.

---

## Part 3: S3 Encryption Options

### Default S3 Encryption (Since January 2023)

**S3 now encrypts all new objects by default using SSE-S3** (AES-256).

You don't need to do anything - it's automatic and free.

### S3 Encryption Types

**1. Server-Side Encryption (SSE)**

Encryption happens on AWS side after upload:

| Type | Key Management | Cost | Use Case |
|------|---------------|------|----------|
| **SSE-S3** | AWS manages (AES-256) | Free | Default, simple encryption |
| **SSE-KMS** | AWS KMS manages | API call costs | Audit trail, key rotation, access control |
| **SSE-C** | Customer provides key | Free | You manage keys externally |

**2. Client-Side Encryption (CSE)**

You encrypt data before uploading to S3:
- You manage encryption process
- You manage keys
- S3 stores encrypted data only
- Use when: Encryption must happen in your environment

### Server-Side vs Client-Side Encryption

**Server-Side Encryption** (Most Common):
```
Your App → Uploads Plain Data → S3 Receives → S3 Encrypts → Stores Encrypted
         ← Downloads Plain Data ← S3 Decrypts ← Retrieves Encrypted
```

**Advantages**:
- No code changes needed
- AWS handles encryption/decryption
- Integrated with IAM and KMS
- CloudTrail logs key usage

**Client-Side Encryption**:
```
Your App → Encrypts Data → Uploads Encrypted → S3 Stores Encrypted
         ← Decrypts Data ← Downloads Encrypted ← S3 Retrieves
```

**Advantages**:
- Data encrypted before leaving your network
- Complete control over encryption process
- S3 never sees plaintext data

**Disadvantages**:
- You write encryption code
- You manage keys
- More complex disaster recovery

### Encryption in Transit

Always use HTTPS (TLS) for data in transit to/from S3.

S3 supports:
- TLS 1.2 (minimum)
- TLS 1.3 (recommended)

Bucket policy to enforce HTTPS:
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Deny",
    "Principal": "*",
    "Action": "s3:*",
    "Resource": "arn:aws:s3:::my-bucket/*",
    "Condition": {
      "Bool": {"aws:SecureTransport": "false"}
    }
  }]
}
```

> **Exam Alert**: Default S3 encryption is SSE-S3 (free, automatic). SSE-KMS provides audit trail and key control. Client-side encryption = you encrypt before upload.

---

## Part 4: Key Policies vs IAM Policies

### How They Work Together

Both must allow for access to work:

```
User Request → IAM Policy Check → Key Policy Check → ALLOWED
                     ↓ Deny              ↓ Deny
                   DENIED             DENIED
```

| Aspect | Key Policy | IAM Policy |
|--------|------------|------------|
| **Attachment** | On KMS key | On user/role |
| **Required** | Yes (every key has one) | No |
| **Evaluated** | First | Second |
| **Cross-account** | Can grant | Cannot grant to KMS |

### Example: EC2 Role Needs to Decrypt

**Key Policy** (on KMS key):
```json
{
  "Effect": "Allow",
  "Principal": {"AWS": "arn:aws:iam::123456789012:role/EC2Role"},
  "Action": ["kms:Decrypt", "kms:DescribeKey"],
  "Resource": "*"
}
```

**IAM Policy** (on EC2 role):
```json
{
  "Effect": "Allow",
  "Action": ["kms:Decrypt", "kms:DescribeKey"],
  "Resource": "arn:aws:kms:us-east-1:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab"
}
```

Both policies must exist. If either is missing, decrypt fails.

---

## Part 5: Envelope Encryption

## Part 5: Envelope Encryption

How AWS services encrypt large amounts of data efficiently:

1. Service requests data encryption key (DEK) from KMS
2. KMS generates DEK and returns plaintext + encrypted version
3. Service encrypts data with plaintext DEK
4. Service stores encrypted data + encrypted DEK together
5. Service discards plaintext DEK from memory

**Decryption Process**:
1. Service retrieves encrypted DEK
2. Service calls KMS to decrypt DEK
3. KMS returns plaintext DEK
4. Service decrypts data with plaintext DEK
5. Service discards plaintext DEK

> **Exam Alert**: KMS never sees your plaintext data. Only data keys are sent to KMS for encryption/decryption.

---

## Part 6: Production Scenarios

### Scenario 1: Multi-Region Application with Encryption

**Problem**: Application runs in us-east-1 and eu-west-1. Need same encrypted data accessible in both regions.

**Solution**: Multi-region KMS keys

```hcl
# Primary key in us-east-1
resource "aws_kms_key" "multi_region" {
  description         = "Multi-region encryption key"
  multi_region        = true
  enable_key_rotation = true
}

# Replica in eu-west-1 (create in different region)
resource "aws_kms_replica_key" "secondary" {
  provider = aws.eu_west_1

  description             = "Replica of multi-region key"
  deletion_window_in_days = 30
  primary_key_arn         = aws_kms_key.multi_region.arn
}
```

**Result**: Same key ID in both regions. Data encrypted in us-east-1 can be decrypted in eu-west-1.

### Scenario 2: Cross-Account S3 Bucket Sharing

**Problem**: Account A owns S3 bucket. Account B needs to read encrypted objects.

**Solution**: Update key policy and bucket policy

**Key Policy** (Account A's KMS key):
```json
{
  "Effect": "Allow",
  "Principal": {"AWS": "arn:aws:iam::222222222222:root"},
  "Action": ["kms:Decrypt", "kms:DescribeKey"],
  "Resource": "*"
}
```

**Bucket Policy** (Account A's S3 bucket):
```json
{
  "Effect": "Allow",
  "Principal": {"AWS": "arn:aws:iam::222222222222:role/DataReader"},
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::account-a-bucket/*"
}
```

**IAM Policy** (Account B's role):
```json
{
  "Effect": "Allow",
  "Action": ["s3:GetObject", "kms:Decrypt"],
  "Resource": [
    "arn:aws:s3:::account-a-bucket/*",
    "arn:aws:kms:us-east-1:111111111111:key/*"
  ]
}
```

### Scenario 3: Encrypting Existing Unencrypted RDS

**Problem**: RDS database is unencrypted. Need to encrypt it.

**Cannot**: Enable encryption on existing RDS instance.

**Solution**:
1. Create snapshot of unencrypted database
2. Copy snapshot with encryption enabled (specify KMS key)
3. Restore new database from encrypted snapshot
4. Update application connection string
5. Delete old unencrypted database

**Downtime**: 15-30 minutes depending on database size.

### Scenario 4: High KMS API Costs from S3

**Problem**: S3 bucket with millions of objects. KMS costs are $500/month.

**Solution**: Enable S3 Bucket Keys

**Before**: Each S3 object encryption = 1 KMS API call  
**After**: S3 bucket key used for multiple objects = 99% fewer KMS calls

```hcl
resource "aws_s3_bucket_server_side_encryption_configuration" "optimized" {
  bucket = aws_s3_bucket.data.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = aws_kms_key.data.arn
    }
    bucket_key_enabled = true  # Reduces API calls by 99%
  }
}
```

**Cost Reduction**: From $500/month to ~$5/month.

### Scenario 5: Audit Who Accessed Encrypted Data

**Problem**: Compliance requires tracking who decrypted sensitive data.

**Solution**: Use encryption contexts + CloudTrail

**Application Code**:
```python
import boto3

kms = boto3.client('kms')

# Encrypt with context
response = kms.encrypt(
    KeyId='alias/sensitive-data',
    Plaintext=b'SSN: 123-45-6789',
    EncryptionContext={
        'Department': 'HR',
        'DataType': 'PII',
        'RecordID': 'EMP-12345'
    }
)

# Decrypt requires same context
plaintext = kms.decrypt(
    CiphertextBlob=response['CiphertextBlob'],
    EncryptionContext={
        'Department': 'HR',
        'DataType': 'PII',
        'RecordID': 'EMP-12345'
    }
)
```

**CloudTrail Log**: Shows who called Decrypt, with what encryption context.

**Result**: Can query "Who accessed employee EMP-12345's PII?"

---

## Part 7: Key Grants

Grants provide temporary, programmatic permissions without modifying key policies.

### When to Use Grants

| Use Grants | Use Key Policy |
|------------|----------------|
| Temporary access (hours/days) | Permanent access |
| Service-to-service delegation | Human administrator access |
| Automated workflows | Cross-account access |
| Lambda execution | Audit and compliance |

### How Grants Work

Lambda needs to decrypt for 1 hour during processing:

1. Create grant for Lambda role with Decrypt + DescribeKey operations
2. Grant returns `GrantToken`
3. Lambda uses token to decrypt without key policy change
4. After processing, revoke grant

**Key point**: Grants are temporary and programmatic - no manual key policy updates needed.

> **Exam Alert**: Use grants for temporary access. Use key policies for permanent access. Grants don't require key policy updates.

---

## Part 8: Cost Optimization

### Pricing

- **Customer managed keys**: $1/month per key
- **API requests**: $0.03 per 10,000 requests
- **S3 Bucket Keys**: Reduce API calls by 99%
- **AWS managed keys**: Free (API calls only)

### Cost Reduction Strategies

**1. Enable S3 Bucket Keys** (99% cost reduction for S3)

**2. Use AWS Managed Keys** for standard encryption:
- No monthly key charge
- Good enough for basic compliance
- Automatic rotation

**3. Consolidate Keys**:
- One key per environment (dev, staging, prod)
- NOT one key per resource
- Balance: security vs cost vs blast radius

**Example**:
- ❌ Bad: 100 microservices = 100 KMS keys = $100/month
- ✅ Good: 1 production key = $1/month

---

## Part 9: Common Issues

| Problem | Cause | Solution |
|---------|-------|----------|
| **Access Denied** | Missing IAM or key policy | Check both policies |
| **Key not found** | Wrong region | KMS keys are regional |
| **Cannot decrypt** | Key deleted | Check key status, restore if pending deletion |
| **High costs** | Too many KMS calls | Enable S3 Bucket Keys |
| **Cannot share snapshot** | Key policy blocks cross-account | Add target account to key policy |
| **Cannot encrypt RDS** | Database already exists | Create encrypted snapshot → restore |

---

## Part 10: Limitations & Quotas

| Resource | Limit |
|----------|-------|
| Customer managed keys per region | 10,000 |
| Grants per key | 50,000 |
| API rate limit (Decrypt) | 5,500 requests/sec |
| Encryption payload size | 4 KB (use envelope encryption for larger) |
| Key deletion waiting period | 7-30 days |

---

## Part 11: Exam Tips

**Key Rules**:
- Key rotation is automatic and FREE
- Default S3 encryption is SSE-S3 (AES-256)
- Both key policy AND IAM policy must allow
- Cannot encrypt existing RDS (snapshot → copy → restore)
- S3 Bucket Keys reduce costs by 99%

**Common Scenarios**:

| Question | Answer |
|----------|--------|
| High KMS costs for S3 | Enable S3 Bucket Keys |
| Cross-account encryption | Key policy + bucket policy + IAM policy |
| Encrypt existing RDS | Snapshot → encrypted copy → restore |
| Key rotation cost | FREE (no extra charge) |
| Default S3 encryption | SSE-S3 (AES-256) - automatic and free |

**Exam Tricks**:
- Key rotation does NOT break old encrypted data
- AWS managed keys rotate every 3 years (not 1 year)
- Grants are temporary, key policies are permanent
- Encryption context adds security layer (logged in CloudTrail)

---

## Quick Reference

### Key Types
- **Symmetric** (AES-256): Most common, cannot export
- **Asymmetric** (RSA/ECC): Public/private pairs, can export public key
- **HMAC**: Token generation and verification

### S3 Encryption
- **Default**: SSE-S3 (free, automatic since Jan 2023)
- **SSE-KMS**: Audit trail, key control (costs API calls)
- **SSE-C**: Customer provides key each request
- **Client-side**: You encrypt before upload

### Essential Commands
```bash
# Create key
aws kms create-key --description "My key"

# Enable rotation
aws kms enable-key-rotation --key-id <key-id>

# Schedule deletion
aws kms schedule-key-deletion --key-id <key-id> --pending-window-in-days 30
```

---

## References

- [AWS KMS Developer Guide](https://docs.aws.amazon.com/kms/latest/developerguide/)
- [KMS Best Practices](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html)
- [Envelope Encryption](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping)